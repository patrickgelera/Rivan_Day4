tls
<!-- Your Monitor Number == #$34T# -->

~~~
!@Cisco
conf t
 enable secret pass
 username admin priv 15 secret pass
 ip domain name net.sec
 line vty 0 14
  transport input all
  password pass
  login local
  exec-timeout 0 0
  end
~~~


Why you should not use unsecure protocols?
- Telnet
- HTTP
- FTP
- SIP

| Auth      |           |
| ---       | ---       |
| Username: | Fav Food? |
| Password: | Dinner?   |

| Username: | College?  |
| Password: | Course?   |

| Username: | admin     |
| Password: | pass      |

!@cmd
ping 10.#$34T#.1.2


Use a secure protocol, SSH
~~~
!@Cisco
conf t
 enable secret pass
 username admin priv 15 secret pass
 ip domain name net.sec
 line vty 0 14
  transport input all
  password pass
  login local
  exec-timeout 0 0
  exit
 crypto key generate rsa modulus 2048 label key
 ip ssh rsa keypair-name key
 ip ssh version 2
~~~






Why VPN?

Deploy: NetOps & CSR1000v

Apply persistent IP address on linux
~~~
!@NetOps
nmcli connection add \
type ethernet \
con-name TunayNaLAN \
if-name ens192 \
ipv4.method manual \
ipv4.addresses 10.#$34T#.1.6/24 \
autoconnect yes

nmcli connection up TunayNaLAN
~~~


CSR1000v - VPN-PH
Login Username: admin
Login Password: pass
MGMT Int: Gig2
MGMT IP: 192.168.102.11/24
Features:
 - Enable SSH & Telnet

CSR1000v - VPN-JP
Login Username: admin
Login Password: pass
MGMT Int: Gig2
MGMT IP: 192.168.102.12/24
Features:
 - Enable SSH & Telnet

<br>

### Execute the Python Script from S2S VPN

!@BLDG-PH
sudo su
ifconfig eth0 11.11.11.100 netmask 255.255.255.224 up
route add default gw 11.11.11.113
ping 11.11.11.113

!@BLDG-JP-1
sudo su
ifconfig eth0 21.21.21.211 netmask 255.255.255.240 up
route add default gw 21.21.21.213
ping 21.21.21.213

!@BLDG-JP-2
sudo su
ifconfig eth0 22.22.22.221 netmask 255.255.255.192 up
route add default gw 22.22.22.223
ping 22.22.22.223



### Add User Accounts
!@All BLDG
sudo su
adduser admin

> New Password:    pass
> Retype Password: pass



| VPN-PH |     VARS       | BLDG-JP  |
| ---    | ---            | ---      |
|        | Authenticate   |          | 
|        |                |          |
|        | PHASE 1        |          |
|        | Encryption     |          |
|        | Integrity      |          |
|        | Group          |          |
|        |                |          |
|        | PHASE 2        |          |
|        | ESP-Encryption |          |
|        | ESP-Hash       |          |
|        | Tunnel IP      |          |
|        | Tunnel Mask    |          |
|        | Source Int     |          |
|        | Peer IP        |          |
|        | Remote Subnets |          |



## Cryptography 
### RSA Key Pair

!@NetOps
ssh-keygen -t rsa -b 1024 -f rsa.key
fold -w 46 rsa.key.pub

or

!@NetOps
openssl genpkey -algorithm RSA -out rsa_priv.key -pkeyopt rsa_keygen_bits:1024
openssl pkey -in rsa_priv.key -pubout -out rsa_pub.key


Verify:
!@cmd
ssh -l root 10.m.1.6/24

### FINGERPRINT
The authenticity of host '10.91.1.6 (10.91.1.6)' can't be established.
ED25519 key fingerprint is SHA256:K1lJBH2lpRJ3UkDLhvobaAwCMwPaCcQuWB5bIb8heBg.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])?

Where are the host private keys located on linux?
!@NetOps
cd /etc/ssh/

Verify the fingerprint
!@NetOps
ssh-keygen -lf ssh_host_ed25519_key.pub

Are the RSA keys used for payload encryption?


## Key Exchange
### Diffie-Hellman 
!@NetOps
openssl dhparam -out dhgroup.pem 1024

openssl genpkey -paramfile dhgroup.pem -out ph_priv.key
openssl pkey -in ph_priv.key -pubout -out ph_pub.key

openssl genpkey -paramfile dhgroup.pem -out jp_priv.key
openssl pkey -in jp_priv.key -pubout -out jp_pub.key

openssl pkeyutl -derive -inkey ph_priv.key -peerkey jp_pub.key -out ph-shared.secret
openssl pkeyutl -derive -inkey jp_priv.key -peerkey ph_pub.key -out jp-shared.secret

View Private key contents
!@NetOps
openssl pkey -in rsa_priv.key -text -noout



******
Encryption types
- Asymmetrical
  Key Pair
  - Private Key
  - Public Key

- Symmetrical
  Shared Key/Session Key

SSH - Server key is used only to verify authenticity.
RSA - Generate Key Pair

### SHA - Hash data for authenticity, hashes encrypted data
!@NetOps
echo my_gcash_info > data.txt
sha256sum data.txt

!@cmd
certutil -hashfile data.txt md5


### AES - Encrypts data in Session
!@NetOps
openssl enc -aes-256-cbc -in data.txt -out data.enc

Salted - add bits of info to the encryption to prevent reverse eng
Make sure to produce different output per encryption.


### DH-GROUP - Establish parameters for ephemeral keys to keep key exchange secure. Shared secret (a lot of math)
!@NetOps
openssl dhparam -out dhgroup.pem 1024


### HMAC-SHA256 - authenticity and identity of payload, use the hash of the shared session key to be added to the unencrypted message, then together both are hashed.
!@NetOps
sha256sum ph-shared.secret
nano pre.hmac
///
hash + unencrypted data
8e8b5b383ab2fac1a686b84a3decae33422d719d6b42648c92192fa3030ee3d6 my_gcash_info
///
openssl enc -aes-256-cbc -in pre.hmac -out hmac


### Signature - Encrypts Hash of the message using Ephemeral Priv Key/longterm private key
!@NetOps
sha256sum data.txt > hash.file
openssl pkeyutl -encrypt -inkey ph_priv.key -in hash.file -out Signature


### Fingerprint - Hash of the shared secret/public key, separate from the message.
!@NetOps
sha256sum rsa_pub.key


2048 key size = secure
******






# Modify Open Ports
!@NetOps
cd 
cat motd_commands.txt



# Port Forwarding

# Privilege Access Management




# Login Auth Methods
  - Basic
  - Pub Key
  - KRB






































## Setup WinServer 2022, DNS, and WebServer
  - Turn off the firewall
  - Change the computer name
  - Configure ip addresses

## Setup DNS and website for sec69.com
  - DNS records with an A record for the CA
  - Website


## Create Private key with a Selfsigned Cert

openssl req -x509 -newkey rsa:2048 -days 365 -keyout privkey-sec69.pem -out rootca-sec69.pem -nodes

*NOTE: The common name must match exactly what the record is. ex. if the site uses www. you add www. to the common name

## Create a Certificate Signing Request

openssl req -newkey rsa:2048 -days 365 -keyout privkey-server-sec69.pem -out req-server-sec69.pem -nodes

*NOTE: the CSR came from the client (sec69.com), which means the information must be for the client.


## Create a Configuration File to add SAN attributes to the certificate.

nano san-server-sec69.com

Paste the SAN 

subjectAltName=DNS:www.sec69.com,DNS:sec69.com,IP:192.168.102.100


## Sign the CSR with the added SAN information

openssl x509 -req -in req-server-sec69.pem -CA rootca-sec69.pem -CAkey privkey-sec69.pem -CAcreateserial -out signed-server-sec69.pem -extfile san-server-sec69.cnf


## Verify SignedCertificate Validiy

openssl verify -CAfile rootca-sec69.pem signed-server-sec69.pem 

## Convert the Signed Certificate to .pfx

openssl pkcs12 -export -out signed-server-sec69.pfx -inkey privkey-server-sec69.pem -in signed-server-sec69.pem

## Transfer the files to Windows

ftp [windows ip]
put rootca-sec69.pem
put signed-server-sec69.pfx 

## Assign the signed-server-sec69.pfx as the SSL certificate for the domain

## Trust the root CA








**************


Create Private key with Selfsigned Cert

@linux
openssl req -x509 -newkey rsa:2048 -days 365 -keyout key-ccna70.pem -out ca-ccna70.pem -subj "C=PH/ST=National Capital Region/L=Makati/O=Rivancorp/OU=IT/CN=ca.ccna70.com/emailAddress=admin@rivanit.com"

*NOTE: Make sure common name is accessible by client

Display Certificate Info

@linux
openssl x509 -in ca-ccna70.pem -noout -text


Create a CSR

@linux
openssl req -newkey rsa:2048 -days 365 -keyout server-key.pem -out server-req.pem -subj "/C=PH/ST=National Capital Region/L=Makati/O=CCNA70/OU=IT/CN=www.ccna70.com/emailAddress=ccna70@rivanit.com"


Sign the CSR

@linux
openssl x509 -req -in server-req.pem -CA ca-ccna70.pem  -CAkey key-ccna70.pem -CAcreateserial -out server-cert.pem -extfile server-ext.cnf


Create a CNF file for SAN

subjectAltName=DNS:www.ccna70.com,DNS:ccna70.com,IP:192.168.102.200


Verify a certificate

@linux
openssl verify -CAfile ca-ccna70.pem server-cert.pem


win + r = mmc

Trust the root CA then convert server cert to pfx then upload to Personal Certificate


















**************
Add Certificate to Website

1. Generate Private key

openssl ciphers -v

For root CA (NetOps)
openssl genrsa -aes256 -out ccna70.pem 2048

For server (Windows)
openssl genrsa -aes256 -out win69.pem 2048


2. Output Root Certificate via Private Key

openssl req -new -x509 -key ccna70.pem -out ccna70.crt -days 365

3. Generate a CSR for the server

Openssl req -new -key win69.pem -out server.csr

FOR PFX

openssl pkcs12 -export -out ccna70_cert.pfx -inkey ccna70_key.pem -in ccna70_cert.crt -addext "subjectAltName = DNS:ccna70.com,DNS:www.ccna70.com"


2. Sign the servers csr using the root CA

openssl x509 -req -in server.csr -CA rivan69.crt -CAkey rivan69.pem -CAcreateserial -out serversigned.crt -days 356 -sha256
**************





Steps
1. Create Private and Public key

For user:admin

[SSH-KEYGEN]

Create Private Key
@linux
ssh-keygen -t rsa -b 2048 -f 



[OPENSSL]
openssl genrsa -out art.pem 2048



Extract Public Key from Private Key

@linux
openssl rsa -in art.pem -pubout -out art_pub.pem

Set Permissions for Keys

@linux
chmod 600 art.pem 
chmod 644 art_pub.pem












JUMPSERVER

*********************
SSH Public Key Authentication

1. Setup SSH.
@Cisco
conf t
 ip domain name security.sec
 crypto key generate rsa modulus 2048
 ip ssh version 2
 line vty 0 14
  login local
  transport input all
  end


2. Create key.
@SecureCRT
	Tools > Create Public Key
	
	Key type: RSA
	Passphrase: 
	Key Length: 2048
	Format: Standard or OpenSSH (new)
	
	
@Cisco
conf t
 crypto key generate rsa modulus 2048 exportable label sec
 crypto key export rsa sec pem terminal 3des C1sc0123
 end

Grab The public and private key and assign them to their own respective file:

  Public Key: sec.pub
  Private Key: sec.priv


@Linux
ssh-keygen -t rsa -b 2048 -f mine
fold -b -w 72 /home/ubuntu/.ssh/id_rsa.pub


3. Create a User with public key-chain.
@Cisco
conf t
 username aerin privilege 15
 ip ssh pubkey-chain
  username aerin
   key-string
    <PASTE PUB KEY>
	exit
   end


4. Disable Password authentication.

@Cisco
conf t
 ip ssh server algorithm authentication publickey
 no ip ssh server algorithm authentication password
 no ip ssh server algorithm authentication keyboard
 end



*********************

PKI Server  (VPN With Certificate Authentication)

VPN-PH
conf t
crypto pki server CA-SERVER
  database url nvram:
  no shutdown
  grant auto     ! (auto-approves requests)
  hash sha256
 crypto pki trustpoint CA-SELF
 enrollment selfsigned
 subject-name CN=CA-SERVER
 revocation-check none
 rsakeypair CA-KEYS
crypto pki enroll CA-SELF
crypto pki server CA-SERVER
  shutdown   ! shut and start again to apply cert
  no shutdown
show crypto pki certificates
show crypto pki server CA-SERVER
show crypto pki certificates CA-SERVER


VPN-JP
conf t
crypto pki trustpoint CA-CLIENT
 enrollment url http://192.168.12.1:80
 subject-name CN=R2
 revocation-check none
 rsakeypair R2-KEY
crypto pki authenticate CA-CLIENT
crypto pki enroll CA-CLIENT

show crypto pki trustpoints
show crypto pki certificates


crypto pki import CA-TP certificate

username certuser attributes
 service-type ssh
 crypto map
  subject-name CN=user1@example.com
  issuer-name CN=CA-SERVER
  
  
  
ip ssh pubkey-chain
  username certuser
    key-hash sha256 <cert fingerprint or hash>

aaa new-model
aaa authentication login SSH_CERT_AUTH local
aaa authorization exec SSH_CERT_AUTH local
ip ssh certificate authentication
line vty 0 4
 login authentication SSH_CERT_AUTH
 transport input ssh
 
 

CERT Authentication

ip ssh certificate authentication
aaa new-model
aaa authentication login SSH_CERT_AUTH local
line vty 0 4
 login authentication SSH_CERT_AUTH
 transport input ssh


crypto isakmp policy 10
 encr aes
 authentication rsa-sig
 hash sha256
 group 2
 lifetime 3600

crypto isakmp identity dn
crypto isakmp trustpoint MY-CA

crypto ipsec transform-set TS esp-aes esp-sha-hmac
crypto map VPN-MAP 10 ipsec-isakmp
 set peer <other-router-ip>
 set transform-set TS















*****************
CERTIFICATE AUTHORITY MANAGEMENT

Gen


Generate a self-signed certificate via OpenSSL

1. Create a private key

@linux
openssl genrsa -out admin_privkey.pem 2048
openssl genrsa -aes256 -out rivan69.pem 2048

2. Output a self-signed certificate via the generated private key.

@linux
openssl req -new -x509 -key admin_privkey.pem -out admin_cert.pem -days 365
openssl req -new -x509 -days 3650 -key rivan69.pem -sha256 -extensions v3_ca -out www.rivan69.com


Certificate Authority

cd /etc/ssl/
nano openssl.cnf


*********
dir flash:
rename flash:pnp-tech-time flash:pnp-tech-time.old 
 match address 100
