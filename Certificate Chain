
Check Supported Ciphers/Cipher Suite

Directory:
C:\ProgramData\Microsoft\Crypto\Keys


!@NetOps
openssl ciphers -v

DNS:
ns   A
ca   A
cert CNAME
__   A
www  A
ftp  CNAME

*******************

SETUP
!@NetOps
mkdir /certs;cd /certs



In order to create an SSL Cert, Certificates MUST be configured.

STEP 1. Create a self-signed cert on linux using openssl. (Sakit ulo windows certreq)

> GENERATE PRIVATE KEY

SERVER
For root CA (NetOps) 
!@NetOps
openssl genrsa -aes256 -out netops-ca.key 2048

SUBCA
For root SUBCA (NetOps) 
!@NetOps
openssl genrsa -aes256 -out netops-subca.key 2048

or

CLIENT
For (Windows)
!@Powershell
$ca = New-SelfSignedCertificate `
  -Subject "CN=RivanCyber Institute CEBU, O=Rivancorp, OU=ICT, L=Cebu, ST=Central Visayas, C=PH" `
  -DnsName "ns.rivancorp.com" `
  -KeyAlgorithm RSA `
  -KeyLength 2048 `
  -HashAlgorithm SHA256 `
  -KeyUsage CertSign, CRLSign, DigitalSignature `
  -KeyUsageProperty Sign `
  -CertStoreLocation "Cert:\LocalMachine\My" `
  -TextExtension @(
    "2.5.29.19={text}ca=true&pathlength=1"
  ) `
  -NotAfter (Get-Date).AddYears(10)


Then, Create and Export the CA

!@NetOps
cd /certs
ftp [IP Address]
ftp> binary
ftp> get win.pfx


> Create an OPENSSL configuration file to support Subject Alt Names

SERVER
!@NetOps
nano ca.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_ca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = Admin
CN = Rivancorp Root CA

[ v3_ca ]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash

[v3_subca]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
~~~



SERVER
!@NetOps
nano subca.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_subca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = IT Department
CN = Rivancorp SubCA

[ v3_subca ]
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, keyCertSign, cRLSign
~~~




CLIENT
!@NetOps
nano win.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = ICT
CN = www.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = www.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.200
~~~



> OUTPUT SELF-SIGNED CA

SERVER
!@NetOps
openssl req \
-new -x509 \
-key netops-ca.key \
-out netops-ca.crt \
-days 365 \
-extensions v3_ca \
-config ca.cnf


> CREATE A CSR FOR THE SUBCA USING THE SELFSIGNED CA

SERVER SUBCA
!@NetOps
openssl req -new \
-key netops-subca.key \
-out netops-subca.csr \
-config subca.cnf \
-extensions v3_subca


> SIGN THE SUBCA CSR USING THE SELFSIGNED CA

!@NetOps
openssl x509 -req \
-in netops-subca.csr \
-CA netops-ca.crt \
-CAkey netops-ca.key \
-CAcreateserial \
-out netops-subca.crt \
-days 3650 \
-extfile ca.cnf \
-extensions v3_subca \
-copy_extensions copy



STEP 2. Generate then sign the CSR for the client

*IF PFX WAS GENERATED BY WINDOWS

> OUTPUT THE PRIVATE KEY
!@NetOps
openssl pkcs12 -in win.pfx -nocerts -out win.key -nodes


> EXPORT THE CERTIFICATE
!@NetOps
openssl pkcs12 -in win.pfx -nokeys -out win.crt

********


> GENERATE A CERTIFICATE SIGNING REQUEST

!@NetOps
openssl req -new \
-key win.key \
-out win.csr \
-config win.cnf \
-extensions v3_leaf


> SIGN THE CSR

Create another file:
!@NetOps
nano win-ext.cnf

~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = www.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.200
~~~


!@NetOps
openssl x509 -req \
  -in win.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-win.pem \
  -days 365 \
  -extfile win-ext.cnf \
  -extensions v3_leaf





STEP 3. Convert the granted certificate to PFX format

> CONVERT PEM TO PFX

!@NetOps
openssl pkcs12 -export \
-in grant-win.pem \
-inkey win.key \
-out grant-win.pfx




STEP 4. Transfer the CA & Granted Certificate to Windows.

> ENABLE FTP ON WINDOWS SERVER



> TRANSFER FILES VIA FTP - NOTE: Make sure PFX files are transferred in Binary NOT ASCII

!@NetOps
cd /certs
ftp [IP]

ftp> put netops-ca.crt
ftp> binary
ftp> put grant-win.pfx



STEP 5. Install the Granted Certificates on Windows IIS

Win + R : mmc


> ADD THE CA (netops.crt) to the Trusted Root Certification Authorities

> INSTALL THE GRANTED CERT (grant-win.pfx) in IIS Manager








*******************
TRANSPORT LAYER SECURITY

> Setup FTP with SSL Certificate

> CREATE ANOTHER SIGNED CERT FOR LINUX

CLIENT
!@NetOps
nano linux.cnf

~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = FTP
CN = ftp.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = ftp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.10
~~~


> GENERATE A CERTIFICATE SIGNING REQUEST

!@NetOps
openssl req -new \
-key netops-ca.key \
-out linux.csr \
-config linux.cnf \
-extensions v3_leaf


> SIGN THE CSR

Create another file:
!@NetOps
nano linux-ext.cnf

~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = ftp.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.10
~~~


!@NetOps
openssl x509 -req \
  -in linux.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-linux.pem \
  -days 365 \
  -extfile linux-ext.cnf \
  -extensions v3_leaf



***************



1. Install lftp

!@NetOps
sudo yum install lftp

2. Access Windows FTP Server

!@NetOps
cd /certs
cat netops-ca.crt netops-subca.crt grant-linux.pem > fullchain.pem
lftp -u administrator [IP ADDRESS]
set ssl:ca-file fullchain.pem
set ftp:ssl-force true
set ftp:ssl-protect-data true

